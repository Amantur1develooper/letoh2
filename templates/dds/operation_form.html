{% extends "base.html" %}
{% block title %}Добавить операцию — Акча-Hotel{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h5 mb-0">Добавить операцию ДДС</h1>
    <div class="text-muted small">Доход/расход влияет на выбранный счет оплаты</div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'dds:dds_list' %}">← Назад</a>
</div>

{% if reg %}
<div class="row g-2 mb-3" id="balances"
  data-cash="{{ reg.cash_balance|default:'0' }}"
  data-mkassa="{{ reg.mkassa_balance|default:'0' }}"
  data-zadatok="{{ reg.zadatok_balance|default:'0' }}"
  data-optima="{{ reg.optima_balance|default:'0' }}"
>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Наличные</div>
      <div class="fs-5"><b>{{ reg.cash_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Mkassa</div>
      <div class="fs-5"><b>{{ reg.mkassa_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Задаток</div>
      <div class="fs-5"><b>{{ reg.zadatok_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Оптима</div>
      <div class="fs-5"><b>{{ reg.optima_balance }}</b></div>
    </div></div>
  </div>
</div>
{% endif %}

<form method="post" class="card app-card" id="ddsForm">
  {% csrf_token %}
  <input type="hidden" name="kind" value="{{ kind|default:'' }}">

  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Отель</label>
        {{ form.hotel }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Статья (доход/расход)</label>
        {{ form.article }}
      </div>

      <div class="col-md-4">
        <label class="form-label">Счет оплаты</label>
        {{ form.method }}
        <div class="text-muted small mt-1" id="accAvailable">Доступно по счету: —</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Сумма</label>
        {{ form.amount }}
        <div class="text-muted small mt-1" id="accAfter">После операции (примерно): —</div>
        <div class="text-muted small">* фактически зависит от того, доход это или расход</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Дата</label>
        {{ form.happened_at }}
      </div>

      <div class="col-12">
        <label class="form-label">Контрагент</label>
        {{ form.counterparty }}
      </div>

      <div class="col-12">
        <label class="form-label">Источник</label>
        {{ form.source }}
      </div>

      <div class="col-12">
        <label class="form-label">Комментарий</label>
        {{ form.comment }}
      </div>

      {% if form.errors %}
      <div class="col-12">
        <div class="alert alert-danger mb-0">
          <b>Ошибки:</b>
          {{ form.non_field_errors }}
          <ul class="mb-0">
            {% for field in form %}
              {% for error in field.errors %}
                <li><b>{{ field.label }}:</b> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary">Сохранить</button>
        <a class="btn btn-outline-secondary" href="{% url 'dds:dds_list' %}">Отмена</a>
      </div>
    </div>
  </div>
</form>

<script>
  (function () {
    const hotelSelect = document.getElementById("id_hotel");
    if (!hotelSelect) return;

    hotelSelect.addEventListener("change", function () {
      const url = new URL(window.location.href);
      if (this.value) url.searchParams.set("hotel", this.value);
      else url.searchParams.delete("hotel");

      const kindEl = document.querySelector("input[name='kind']");
      if (kindEl && kindEl.value) url.searchParams.set("kind", kindEl.value);

      window.location.href = url.toString();
    });
  })();
</script>

<script>
(function(){
  const balances = document.getElementById("balances");
  if(!balances) return;

  const form = document.getElementById("ddsForm");
  const methodEl = form.querySelector('[name="method"]');
  const amountEl = form.querySelector('[name="amount"]');
  const kindEl = form.querySelector('[name="kind"]');

  const box1 = document.getElementById("accAvailable");
  const box2 = document.getElementById("accAfter");

  function toNum(v){
    v = (v ?? "0").toString().replace(",", ".").trim();
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function getBalance(code){
    return toNum(balances.dataset[code] || "0");
  }
  function update(){
    const acc = methodEl ? methodEl.value : "cash";
    const bal = getBalance(acc);
    const amt = toNum(amountEl ? amountEl.value : "0");

    const kind = kindEl ? (kindEl.value || "") : "";
    const after = (kind === "income") ? (bal + amt) : (bal - amt);

    box1.textContent = "Доступно по счету: " + bal.toFixed(2);
    box2.textContent = "После операции (примерно): " + after.toFixed(2);
  }

  if(methodEl) methodEl.addEventListener("change", update);
  if(amountEl) amountEl.addEventListener("input", update);
  update();
})();
</script>

{% endblock %}
