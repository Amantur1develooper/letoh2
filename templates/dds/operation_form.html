{% extends "base.html" %}
{% block title %}Добавить операцию — Акча-Hotel{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h5 mb-0">Добавить операцию ДДС</h1>
    <div class="text-muted small">Доход/расход влияет на выбранный счет оплаты</div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'dds:dds_list' %}">← Назад</a>
</div>

{% if reg %}
<div class="row g-2 mb-3" id="balances"
  data-cash="{{ reg.cash_balance|default:'0' }}"
  data-mkassa="{{ reg.mkassa_balance|default:'0' }}"
  data-zadatok="{{ reg.zadatok_balance|default:'0' }}"
  data-optima="{{ reg.optima_balance|default:'0' }}"
>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Наличные</div>
      <div class="fs-5"><b>{{ reg.cash_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Mkassa</div>
      <div class="fs-5"><b>{{ reg.mkassa_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Задаток</div>
      <div class="fs-5"><b>{{ reg.zadatok_balance }}</b></div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card app-card"><div class="card-body">
      <div class="text-muted small">Оптима</div>
      <div class="fs-5"><b>{{ reg.optima_balance }}</b></div>
    </div></div>
  </div>
</div>
{% endif %}

<form method="post" class="card app-card" id="ddsForm">
  {% csrf_token %}
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Отель</label>
        {{ form.hotel }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Статья (доход/расход)</label>
        {{ form.article }}
      </div>

      <div class="col-md-4">
        <label class="form-label">Счет оплаты</label>
        {{ form.method }}
        <div class="text-muted small mt-1" id="accAvailable">Доступно по счету: —</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Сумма</label>
        {{ form.amount }}
        <div class="text-muted small mt-1" id="accAfter">После операции (примерно): —</div>
        <div class="text-muted small">* фактически зависит от того, доход это или расход</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Дата</label>
        {{ form.happened_at }}
      </div>

      <div class="col-12">
        <label class="form-label">Источник</label>
        {{ form.source }}
      </div>

      <div class="col-12">
        <label class="form-label">Комментарий</label>
        {{ form.comment }}
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary">Сохранить</button>
        <a class="btn btn-outline-secondary" href="{% url 'dds:dds_list' %}">Отмена</a>
      </div>
    </div>
  </div>
</form>

<script>
(function(){
  const balances = document.getElementById("balances");
  if(!balances) return;

  const form = document.getElementById("ddsForm");
  const methodEl = form.querySelector('[name="method"]');
  const amountEl = form.querySelector('[name="amount"]');

  const box1 = document.getElementById("accAvailable");
  const box2 = document.getElementById("accAfter");

  function toNum(v){
    v = (v ?? "0").toString().replace(",", ".").trim();
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function getBalance(code){
    return toNum(balances.dataset[code] || "0");
  }
  function update(){
    const acc = methodEl ? methodEl.value : "cash";
    const bal = getBalance(acc);
    const amt = toNum(amountEl ? amountEl.value : "0");

    box1.textContent = "Доступно по счету: " + bal.toFixed(2);
    // тут считаем “примерно”, без знания доход/расход. Реально проверка на сервере всё равно есть.
    box2.textContent = "После операции (примерно): " + (bal - amt).toFixed(2);
  }

  if(methodEl) methodEl.addEventListener("change", update);
  if(amountEl) amountEl.addEventListener("input", update);
  update();
})();
</script>

{% endblock %}
