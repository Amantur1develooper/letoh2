{% extends "base.html" %}
{% block title %}{{ hotel.name }} — Акча-Hotel{% endblock %}

{% block content %}

<form class="row g-2 mb-3">
  <div class="col-md-4">
    <input type="date" class="form-control" name="date_from" value="{{ date_from|date:'Y-m-d' }}">
  </div>
  <div class="col-md-4">
    <input type="date" class="form-control" name="date_to" value="{{ date_to|date:'Y-m-d' }}">
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-dark">Показать</button>
  </div>
  <div class="col-md-2 d-grid">
    <a class="btn btn-outline-success"
       href="{% url 'dds:hotel_export_excel' hotel.id %}?date_from={{ date_from|date:'Y-m-d' }}&date_to={{ date_to|date:'Y-m-d' }}">
      Excel
    </a>
  </div>
</form>
<a class="btn btn-outline-primary"
   href="{% url 'dds:cash_transfer_create' hotel.id %}">
  Перевод между счетами
</a>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{{ hotel.name }}</h1>
    <div class="text-muted small">Касса (нал/безнал) и ДДС по отелю</div>
  </div>
  <div class="d-flex gap-2">
   

    <a class="btn btn-outline-secondary" href="{% url 'dds:hotel_list' %}">← Отели</a>
    <a class="btn btn-outline-dark" href="{% url 'dds:incasso_create' hotel.id %}">Инкассация</a>
     <a class="btn btn-sm btn-primary" href="{% url 'dds:income_add' hotel.id %}">+ Доход</a>
<a class="btn btn-sm btn-danger" href="{% url 'dds:expense_add' hotel.id %}">+ Расход</a>
    {% comment %} <a class="btn btn-primary" href="{% url 'dds:dds_create' %}">+ Операция</a> {% endcomment %}
  </div>
</div>

<!-- ✅ Реальные остатки (касса/счета) -->
<div class="row g-2 mb-3">
  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Наличные (на руках)</div>
        <div class="fs-3"><b>{{ reg.cash_balance }}</b></div>
        <div class="text-muted small mt-2">Это реальный остаток кассы по движениям</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Безналичные счета</div>
        <div class="mt-2 d-flex justify-content-between">
          <span class="text-muted">Банк1</span><b>{{ reg.mkassa_balance }}</b>
        </div>
        <div class="mt-1 d-flex justify-content-between">
          <span class="text-muted">Задаток</span><b>{{ reg.zadatok_balance }}</b>
        </div>
        <div class="mt-1 d-flex justify-content-between">
          <span class="text-muted">Банк2</span><b>{{ reg.optima_balance }}</b>
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between">
          <span class="text-muted">Итого безнал</span><b>{{ reg.noncash_total }}</b>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Итого денег (нал + безнал)</div>
        <div class="fs-3"><b>{{ reg.total }}</b></div>
        <div class="text-muted small mt-2">Сумма по всем счетам</div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ ДДС итоги за период -->
<div class="row g-2 mb-3">
  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Доход с номеров (за период)</div>
        <div class="fs-4"><b>{{ rooms_income_total }}</b></div>
        <div class="text-muted small">* по source="rooms" / названию статьи</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Общий приход (за период)</div>
        <div class="fs-4"><b>{{ income_total }}</b></div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card app-card">
      <div class="card-body">
        <div class="text-muted small">Расход / Остаток (за период)</div>
        <div class="fs-6">Расход: <b>{{ expense_total }}</b></div>
        <div class="fs-5">Остаток: <b>{{ balance }}</b></div>
      </div>
    </div>
  </div>
</div>
<!-- ✅ Доходы / Расходы по категориям и подкатегориям -->
<div class="row g-2 mb-3">
  <!-- ДОХОДЫ -->
  <div class="col-md-6">
    <div class="card app-card">
      <div class="card-body">
        <h2 class="h6 mb-3">Доходы — по категориям</h2>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Категория</th>
                <th class="text-end">Сумма</th>
              </tr>
            </thead>
            <tbody>
              {% for g in income_groups %}
                <tr class="table-light">
                  <td><b>{{ g.name }}</b></td>
                  <td class="text-end"><b>{{ g.total }}</b></td>
                </tr>

                {% for s in g.subs %}
                <tr>
                  <td class="ps-4">— {{ s.name }}</td>
                  <td class="text-end">{{ s.total }}</td>
                </tr>
                {% endfor %}
              {% empty %}
                <tr><td colspan="2" class="text-muted">Нет доходов за период</td></tr>
              {% endfor %}

              {% if income_uncat %}
              <tr>
                <td class="text-muted">Без категории</td>
                <td class="text-end text-muted">{{ income_uncat }}</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- РАСХОДЫ -->
  <div class="col-md-6">
    <div class="card app-card">
      <div class="card-body">
        <h2 class="h6 mb-3">Расходы — по категориям</h2>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Категория</th>
                <th class="text-end">Сумма</th>
              </tr>
            </thead>
            <tbody>
              {% for g in expense_groups %}
                <tr class="table-light">
                  <td><b>{{ g.name }}</b></td>
                  <td class="text-end"><b>{{ g.total }}</b></td>
                </tr>

                {% for s in g.subs %}
                <tr>
                  <td class="ps-4">— {{ s.name }}</td>
                  <td class="text-end">{{ s.total }}</td>
                </tr>
                {% endfor %}
              {% empty %}
                <tr><td colspan="2" class="text-muted">Нет расходов за период</td></tr>
              {% endfor %}

              {% if expense_uncat %}
              <tr>
                <td class="text-muted">Без категории</td>
                <td class="text-end text-muted">{{ expense_uncat }}</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ✅ Разбивка по счетам за период -->
<div class="card app-card mb-3">
  <div class="card-body">
    <h2 class="h6 mb-3">ДДС за период — по счетам</h2>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Счёт</th>
            <th class="text-end">Приход</th>
            <th class="text-end">Расход</th>
            <th class="text-end">Разница</th>
          </tr>
        </thead>
        <tbody>
         <tbody>
  {% for r in period_rows %}
  <tr>
    <td><b>{{ r.label }}</b></td>
    <td class="text-end">{{ r.income }}</td>
    <td class="text-end">{{ r.expense }}</td>
    <td class="text-end"><b>{{ r.delta }}</b></td>
  </tr>
  {% empty %}
  <tr><td colspan="4" class="text-muted">Нет данных за период</td></tr>
  {% endfor %}
</tbody>

        </tbody>
      </table>
    </div>
    <div class="text-muted small">
      Примечание: это “оборот за период”, а реальные остатки — сверху (касса/счета).
    </div>
  </div>
</div>

<!-- ✅ Последние операции -->
<div class="card app-card mb-3">
  <div class="card-body">
    <h2 class="h6 mb-3">Последние операции</h2>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Статья</th>
            <th>Счёт</th>
            <th class="text-end">Сумма</th>
            <th>Источник</th>
          </tr>
        </thead>
        <tbody>
          {% for op in last_ops %}
          <tr>
            <td>{{ op.happened_at|date:"d.m.Y H:i" }}</td>
            <td>{{ op.article.get_kind_display }} — {{ op.article.name }}</td>
            <td>{{ op.get_method_display }}</td>
            <td class="text-end"><b>{{ op.amount }}</b></td>
            <td class="text-muted">{{ op.source|default:"—" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted">Операций пока нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ✅ Доход с номеров по дням -->
<div class="card app-card mb-3">
  <div class="card-body">
    <h2 class="h6 mb-3">Доход с номеров по дням</h2>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Дата</th>
            <th class="text-end">Сумма</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rooms_by_day %}
          <tr>
            <td>{{ r.day|date:"d.m.Y" }}</td>
            <td class="text-end"><b>{{ r.total }}</b></td>
          </tr>
          {% empty %}
          <tr><td colspan="2" class="text-muted">Нет доходов с номеров за период</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{% endblock %}
